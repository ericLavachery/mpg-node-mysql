<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>MPG</title>
        <link rel="stylesheet" href="/static/style.css">
    </head>

    <body>
        <h1>MPG <span id="pseu"></span></h1>

        <div id="pascon">
            <p><input type="button" value="Connexion" id="hello" /></p>
        </div>

        <div id="con">
            <table>
                <tr>
                    <td>
                        <div class="grid-container" id="zone_map">
                            <!-- <div id="17" class="grid-item plains" onclick="changeTerrain(this)">
                                <img src="/static/img/units/space-suit.png" alt="">
                            </div> -->
                        </div>
                        <br>
                        <button type="button" name="medit" id="medit">Map Editor</button>
                    </td>
                    <td>
                        <button type="button" name="medit" id="nextButton">Next Turn</button>
                        <br><br>
                        <div id="infos">
                            <!-- <span class="paramName">Moves</span><span class="paramValue">70</span><br> -->
                        </div>
                    </td>
                </tr>
            </table>
        </div>

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/nav.js"></script>
        <script>

        let pop = [];
        let world = [];
        let selectedUnit = {
            id: '',
            pic: '',
            tileId: '',
            x: '',
            y: ''
        };
        let diag = false;
        console.log(selectedUnit.pic);

            // Quand on reçoit la carte, on l'insère dans la page
            socket.on('mapload', function(wmap) {
                world = wmap;
                showMap(wmap);
            });
            // Dessine la carte
            function showMap(wmap) {
                // reset
                document.getElementById("zone_map").innerHTML = '';
                // fill
                wmap.forEach(function(tile) {
                    // console.log(tile);
                    $('#zone_map').append('<div id="' + tile.id + '" class="grid-item ' + tile.terrain + '" onclick="selectOrMove(this)">' + tile.x + '.' + tile.y + '</div>');
                });
            };
            // infos terrains
            socket.on('terload', function(wter) {
                ter = wter;
            });

            // Affichage des unités
            socket.on('popload', function(wpop) {
                pop = wpop;
                showPop(wpop);
            });
            function showPop(wpop) {
                wpop.forEach(function(unit) {
                    showUnit(unit.id, unit.tileId, unit.pic);
                });
            };
            function showUnit(unitId, tileId, pic) {
                $('#'+tileId).empty().append('<img src="/static/img/units/'+pic+'" alt="'+pic+'" id="u'+unitId+'">');
            };
            socket.on('unit_moved', function(mvi) {
                showOpponentMove(mvi.tileId, mvi.unitId);
            });
            function showOpponentMove(tileId, unitId) {
                objIndex = pop.findIndex((obj => obj.id == unitId));
                let movedUnitOldTileId = pop[objIndex].tileId;
                let movedUnitPic = pop[objIndex].pic;
                // bouge l'image sur la carte
                $('#'+movedUnitOldTileId).empty();
                $('#'+tileId).empty().append('<img src="/static/img/units/'+movedUnitPic+'" alt="'+movedUnitPic+'" id="u'+unitId+'">');
                // change le tileId dans pop
                pop[objIndex].tileId = tileId;
            };

            // Click MAP : Select unit or move selected unit to that tile
            function selectOrMove(gridItem) {
                let tileId = gridItem.id;
                let unitId = 0;
                let imgId = 0;
                // Is there a unit on the tile?
                if (Object.keys(gridItem.children).length >= 1) {
                    unitId = gridItem.children[0].id.substring(1);
                    imgId = gridItem.children[0].id;
                    unitOwner = pop[unitId-1].player;
                }
                console.log('unit '+unitId+'-'+unitOwner+' / tile '+tileId);
                if (unitId >= 1) { // there is a unit
                    if (selectedUnit.id === unitId) { // unit already selected => unselect
                        selectedUnit = {
                            id: '',
                            pic: '',
                            tileId: '',
                            x: '',
                            y: ''
                        };
                        $("#"+imgId).attr("src", gridItem.children[0].src.replace("/sunits/", "/units/"));
                        $('#infos').empty();
                    } else { // unit not selected
                        if (unitOwner === pseudo) { // select the unit
                            selectedUnit.id = unitId;
                            selectedUnit.pic = gridItem.children[0].alt;
                            selectedUnit.tileId = tileId;
                            selectedUnit.x = world[tileId-1].x;
                            selectedUnit.y = world[tileId-1].y;
                            // unmark all units (from pseudo)
                            pop.forEach(function(unit) {
                                if (unit.player === pseudo) {
                                    $("#u"+unit.id).attr("src", gridItem.children[0].src.replace("/sunits/", "/units/"));
                                }
                            });
                            // mark the unit
                            $("#"+imgId).attr("src", gridItem.children[0].src.replace("/units/", "/sunits/"));
                            // show unit infos
                            showUnitInfos(unitId);
                        }
                    }
                } else { // there is no unit
                    if (selectedUnit.id !== '') { // there is a selected unit => move it here
                        moveUnit(tileId);
                    } else { // there is no selected unit => show tile info
                        // terrain / tile infos
                    }
                }
            };
            function showUnitInfos(unitId) {
                $('#infos').empty();
                let unitIndex = pop.findIndex((obj => obj.id == unitId));
                let move = pop[unitIndex].move;
                let moveAdj = pop[unitIndex].moveAdj;
                let fatigue = pop[unitIndex].fatigue;
                if (fatigue < 0) {fatigue = 0;};
                let movesLeft = move-fatigue;
                let hpLeft = pop[unitIndex].hp-pop[unitIndex].damage;
                $('#infos').append('<h3>'+pop[unitIndex].type+'</h3><br>');
                $('#infos').append('<span class="paramName">Owner</span><span class="paramValue">'+pop[unitIndex].player+'</span><br>');
                $('#infos').append('<span class="paramName">Moves</span><span class="paramValue">'+move+'</span><br>');
                $('#infos').append('<span class="paramName">Moves left</span><span id="infosMovesLeft" class="paramValue">'+movesLeft+'</span><br>');
                $('#infos').append('<span class="paramName">HP</span><span class="paramValue">'+pop[unitIndex].hp+'</span><br>');
                $('#infos').append('<span class="paramName">HP left</span><span class="paramValue">'+hpLeft+'</span><br>');
                $('#infos').append('<span class="paramName">Attack</span><span class="paramValue">'+pop[unitIndex].attack+'</span><br>');
                $('#infos').append('<span class="paramName">Defense</span><span class="paramValue">'+pop[unitIndex].defense+'</span><br>');
                $('#infos').append('<span class="paramName">Power</span><span class="paramValue">'+pop[unitIndex].power+'</span><br>');
                $('#infos').append('<span class="paramName">Cover</span><span class="paramValue">'+pop[unitIndex].coverAdj+'</span><br>');
            };
            function isAdjacent(myTileId, thatTileId) {
                let myTileX = world[myTileId-1].x;
                let myTileY = world[myTileId-1].y;
                let thatTileX = world[thatTileId-1].x;
                let thatTileY = world[thatTileId-1].y;
                let tot = 0;
                if (thatTileX == myTileX+1 || thatTileX == myTileX-1) {
                    tot = tot + 1;
                }
                if (thatTileY == myTileY+1 || thatTileY == myTileY-1) {
                    tot = tot + 1;
                }
                if (tot >= 2) {
                    diag = true;
                }
                if (thatTileX == myTileX+1 || thatTileX == myTileX || thatTileX == myTileX-1) {
                    if (thatTileY == myTileY+1 || thatTileY == myTileY || thatTileY == myTileY-1) {
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return false;
                }
            };
            function moveUnit(tileId) {
                if (isAdjacent(selectedUnit.tileId,tileId)) {
                    // tile move cost
                    let tileIndex = world.findIndex((obj => obj.id == tileId));
                    let terrainIndex = ter.findIndex((obj => obj.id == world[tileIndex].terrainId));
                    let moveCost = ter[terrainIndex].moveCost;
                    // unit move cost
                    let unitIndex = pop.findIndex((obj => obj.id == selectedUnit.id));
                    let move = pop[unitIndex].move;
                    let moveAdj = pop[unitIndex].moveAdj;
                    let fatigue = pop[unitIndex].fatigue;
                    if (fatigue < 0) {
                        fatigue = 0;
                    }
                    let movesLeft = move-fatigue;
                    if (diag) {
                        let mc2 = (moveCost*moveCost)+(moveCost*moveCost);
                        moveCost = Math.round(Math.sqrt(mc2));
                        moveCost = Math.round(((moveCost-30)*moveAdj/100)+30);
                    } else {
                        moveCost = Math.round(((moveCost-30)*moveAdj/100)+30);
                    }
                    console.log(moveCost);
                    if (movesLeft*3 >= moveCost) {
                        fatigue = fatigue+moveCost;
                        movesLeft = move-fatigue;
                        // bouge l'image sur la carte
                        $('#'+selectedUnit.tileId).empty();
                        $('#'+tileId).empty().append('<img src="/static/img/sunits/'+selectedUnit.pic+'" alt="'+selectedUnit.pic+'" id="u'+selectedUnit.id+'">');
                        // change infos dans pop
                        pop[unitIndex].tileId = tileId;
                        pop[unitIndex].fatigue = fatigue;
                        // change le tile dans selectedUnit
                        selectedUnit.tileId = tileId;
                        // envoi au serveur
                        socket.emit('move_unit', { tileId: tileId, unitId: selectedUnit.id, fatigue: fatigue});
                        $('#infosMovesLeft').empty().append(movesLeft);
                    }
                }
            };

            // NEXT TURN
            $('#nextButton').click(nextTurn);
            function nextTurn() {
                pop.forEach(function(unit) {
                    if (unit.player === pseudo) {
                        if (unit.fatigue-unit.move >= 0) {
                            unit.fatigue = unit.fatigue-unit.move;
                        } else {
                            unit.fatigue = 0;
                        }
                        if (unit.id == selectedUnit.id) {
                            $('#infosMovesLeft').empty().append(unit.move-unit.fatigue);
                        }
                    }
                });
                socket.emit('next_turn', { pseudo: pseudo, turns: 1 });
            }

        </script>
    </body>
</html>
