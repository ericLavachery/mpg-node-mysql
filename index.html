<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>MPG</title>
        <link rel="stylesheet" href="/static/style.css">
    </head>

    <body>
        <h1>MPG <span id="pseu"></span></h1>

        <div id="pascon">
            <p><input type="button" value="Connexion" id="hello" /></p>
        </div>

        <div id="con">
            <table>
                <tr>
                    <td>
                        <div class="grid-container" id="zone_map">
                            <!-- <div id="17" class="grid-item plains" onclick="changeTerrain(this)">
                                <img src="/static/img/units/space-suit.png" alt="">
                            </div> -->
                        </div>
                    </td>
                    <td>
                        <button type="button" name="medit" id="medit">Map Editor >>></button>
                    </td>
                </tr>
            </table>
        </div>

        <script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>
        <script src="/socket.io/socket.io.js"></script>
        <script src="/static/nav.js"></script>
        <script>

        let pop = [];
        let world = [];
        let selectedUnit = {
            id: '',
            pic: '',
            tileId: '',
            x: '',
            y: ''
        };
        console.log(selectedUnit.pic);

            // Quand on reçoit un la carte, on l'insère dans la page
            socket.on('mapload', function(wmap) {
                world = wmap;
                showMap(wmap);
            })
            // Dessine la carte
            function showMap(wmap) {
                // reset
                document.getElementById("zone_map").innerHTML = '';
                // fill
                wmap.forEach(function(tile) {
                    // console.log(tile);
                    $('#zone_map').append('<div id="' + tile.id + '" class="grid-item ' + tile.terrain + '" onclick="selectOrMove(this)">' + tile.x + '.' + tile.y + '</div>');
                });
            }

            // Affichage des unités
            socket.on('popload', function(wpop) {
                pop = wpop;
                showPop(wpop);
            })
            function showPop(wpop) {
                wpop.forEach(function(unit) {
                    showUnit(unit.id, unit.tileId, unit.pic);
                });
            }
            function showUnit(unitId, tileId, pic) {
                $('#'+tileId).empty().append('<img src="/static/img/units/'+pic+'" alt="'+pic+'" id="u'+unitId+'">');
            }
            socket.on('unit_moved', function(mvi) {
                showOpponentMove(mvi.tileId, mvi.unitId);
            })
            function showOpponentMove(tileId, unitId) {
                objIndex = pop.findIndex((obj => obj.id == unitId));
                let movedUnitOldTileId = pop[objIndex].tileId;
                let movedUnitPic = pop[objIndex].pic;
                // bouge l'image sur la carte
                $('#'+movedUnitOldTileId).empty();
                $('#'+tileId).empty().append('<img src="/static/img/units/'+movedUnitPic+'" alt="'+movedUnitPic+'" id="u'+unitId+'">');
                // change le tileId dans pop
                pop[objIndex].tileId = tileId;
            }

            // Click MAP : Select unit or move selected unit to that tile
            function selectOrMove(gridItem) {
                let tileId = gridItem.id;
                let unitId = 0;
                let imgId = 0;
                if (Object.keys(gridItem.children).length >= 1) {
                    unitId = gridItem.children[0].id.substring(1);
                    imgId = gridItem.children[0].id;
                }
                console.log('unit '+unitId+' / tile '+tileId);
                if (unitId >= 1) {
                    if (selectedUnit.id === unitId) {
                        selectedUnit = {
                            id: '',
                            pic: '',
                            tileId: '',
                            x: '',
                            y: ''
                        };
                        $("#"+imgId).attr("src", gridItem.children[0].src.replace("/sunits/", "/units/"));
                    } else {
                        selectedUnit.id = unitId;
                        selectedUnit.pic = gridItem.children[0].alt;
                        selectedUnit.tileId = tileId;
                        selectedUnit.x = world[tileId-1].x;
                        selectedUnit.y = world[tileId-1].y;
                        $("#"+imgId).attr("src", gridItem.children[0].src.replace("/units/", "/sunits/"));
                    }
                } else {
                    if (selectedUnit.id !== '') {
                        moveUnit(tileId);
                    }
                }
            }
            function isAdjacent(myTileId, thatTileId) {
                let myTileX = world[myTileId-1].x;
                let myTileY = world[myTileId-1].y;
                let thatTileX = world[thatTileId-1].x;
                let thatTileY = world[thatTileId-1].y;
                if (thatTileX == myTileX+1 || thatTileX == myTileX || thatTileX == myTileX-1) {
                    if (thatTileY == myTileY+1 || thatTileY == myTileY || thatTileY == myTileY-1) {
                        return true;
                    } else {
                        return false;
                    }
                } else {
                    return false;
                }
            }
            function moveUnit(tileId) {
                if (isAdjacent(selectedUnit.tileId,tileId)) {
                    // bouge l'image sur la carte
                    $('#'+selectedUnit.tileId).empty();
                    $('#'+tileId).empty().append('<img src="/static/img/sunits/'+selectedUnit.pic+'" alt="'+selectedUnit.pic+'" id="u'+selectedUnit.id+'">');
                    // change la place dans pop
                    objIndex = pop.findIndex((obj => obj.id == selectedUnit.id));
                    pop[objIndex].tileId = tileId;
                    // change le tile dans selectedUnit
                    selectedUnit.tileId = tileId;
                    // envoi au serveur
                    socket.emit('move_unit', { tileId: tileId, unitId: selectedUnit.id});
                }
            }


        </script>
    </body>
</html>
